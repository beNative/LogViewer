<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Log Analyser</title>

    <!-- DIAGNOSTIC SCRIPT v5.0 -->
    <script>
      (function() {
        // Run as soon as the DOM is interactive
        document.addEventListener('DOMContentLoaded', function() {
          const report = [];
          const container = document.createElement('div');
          container.id = 'diagnostic-panel';
          document.body.prepend(container);
          
          const styles = `
            #diagnostic-panel { 
              position: fixed; top: 10px; left: 10px; background: #fffff0; color: #333; border: 2px solid red; 
              padding: 15px; font-family: monospace; font-size: 13px; z-index: 999999; max-width: 95%; 
              max-height: 95vh; overflow: auto; line-height: 1.6; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }
            #diagnostic-panel h3 { font-size: 16px; margin: 0 0 10px; padding: 0 0 5px; border-bottom: 1px solid #ccc; font-weight: bold; }
            #diagnostic-panel h4 { font-size: 14px; margin: 15px 0 5px; font-weight: bold; }
            #diagnostic-panel code { background: #f0f0f0; padding: 2px 5px; border-radius: 3px; }
            #diagnostic-panel .error { color: red; font-weight: bold; }
            #diagnostic-panel .ok { color: green; font-weight: bold; }
            #diagnostic-panel .warn { color: orange; font-weight: bold; }
            #diagnostic-panel ul { margin: 0; padding-left: 20px; list-style-position: inside; }
          `;
          const styleSheet = document.createElement("style");
          styleSheet.innerText = styles;
          document.head.appendChild(styleSheet);
          
          report.push('<h3>--- Diagnostic Report (v5.0) ---</h3>');
          report.push("<p>Please copy this entire report in your next message.</p>");
          report.push('<hr style="margin: 10px 0; border: none; border-top: 1px dashed #ccc;">');

          // 1. Base URI Check
          report.push('<h4>1. Base URI Check:</h4>');
          report.push(`<ul><li><code>document.baseURI</code>: ${document.baseURI}</li>`);
          if (document.baseURI.startsWith('http')) {
            report.push(`<li><span class="error">[ANALYSIS]: CRITICAL ERROR!</span> The base URI is an external address. This will cause local file paths (like <code>./dist/styles.css</code>) to fail. This is likely caused by a <code>&lt;base&gt;</code> tag being injected into the HTML by the preview environment.</li>`);
          } else {
             report.push(`<li><span class="ok">[ANALYSIS]: OK.</span> The base URI appears to be local.</li>`);
          }
          report.push('</ul>');

          // 2. Import Map Check
          report.push('<h4>2. Import Map Check:</h4>');
          const importMap = document.querySelector('script[type="importmap"]');
          if (importMap) {
            report.push(`<ul><li>Status: <span class="error">Found!</span></li>`);
            report.push(`<li><span class="error">[ANALYSIS]: CRITICAL ERROR!</span> A <code>&lt;script type="importmap"&gt;</code> tag exists. This conflicts with the bundled JavaScript (<code>bundle.js</code>) and will prevent the application from starting. This tag must be removed from the final HTML.</li></ul>`);
          } else {
            report.push(`<ul><li>Status: <span class="ok">Not Found.</span></li>`);
            report.push(`<li><span class="ok">[ANALYSIS]: OK.</span> No conflicting import map was found.</li></ul>`);
          }
          
          report.push('<h4>3. Asset Fetch Test:</h4>');
          const promises = [];
          
          // Test Stylesheet
          const stylesheetLink = document.querySelector('link[rel="stylesheet"]');
          if (stylesheetLink) {
              const cssUrl = stylesheetLink.href;
              report.push(`<ul><li>Attempting to fetch stylesheet: <code>${cssUrl}</code></li>`);
              const p1 = fetch(cssUrl)
                .then(response => {
                    report.push(`<li>&nbsp;&nbsp;↳ HTTP Status: <span class="${response.ok ? 'ok' : 'error'}">${response.status} ${response.statusText}</span></li>`);
                    if (!response.ok) {
                        report.push(`<li>&nbsp;&nbsp;↳ <span class="error">[ANALYSIS]: FAILURE.</span> The CSS file could not be loaded from this path.</li>`);
                    } else {
                        return response.text().then(text => {
                            const snippet = text.trim().substring(0, 200).replace(/</g, '&lt;');
                            report.push(`<li>&nbsp;&nbsp;↳ <span class="ok">[ANALYSIS]: SUCCESS.</span> File was fetched.</li>`);
                            report.push(`<li>&nbsp;&nbsp;↳ Content Snippet: <pre style="background:#f0f0f0; padding:5px; border-radius:3px; margin-top:5px; white-space: pre-wrap; word-break: break-all;"><code>${snippet}...</code></pre></li>`);
                        });
                    }
                })
                .catch(err => {
                    report.push(`<li>&nbsp;&nbsp;↳ <span class="error">Network Error: ${err.message}.</span> This is often a CORS policy error, indicating the browser is blocked from fetching the resource from a different origin.</li>`);
                    report.push(`<li>&nbsp;&nbsp;↳ <span class="error">[ANALYSIS]: FAILURE.</span> The CSS file could not be loaded.</li>`);
                });
              promises.push(p1);
              report.push('</ul>');
          } else {
              report.push('<ul><li><span class="error">No stylesheet <code>&lt;link&gt;</code> tag found.</span></li></ul>');
          }

          // Test Script
          const scriptTag = document.querySelector('script[src*="bundle.js"]');
           if (scriptTag) {
              const scriptUrl = scriptTag.src;
              report.push(`<ul><li>Attempting to fetch script: <code>${scriptUrl}</code></li>`);
              const p2 = fetch(scriptUrl)
                .then(response => {
                    report.push(`<li>&nbsp;&nbsp;↳ HTTP Status: <span class="${response.ok ? 'ok' : 'error'}">${response.status} ${response.statusText}</span></li>`);
                    if (!response.ok) {
                        report.push(`<li>&nbsp;&nbsp;↳ <span class="error">[ANALYSIS]: FAILURE.</span> The JS bundle could not be loaded from this path. This is a fatal error.</li>`);
                    } else {
                         report.push(`<li>&nbsp;&nbsp;↳ <span class="ok">[ANALYSIS]: SUCCESS.</span> File was fetched.</li>`);
                    }
                })
                .catch(err => {
                    report.push(`<li>&nbsp;&nbsp;↳ <span class="error">Network Error: ${err.message}.</span> (CORS policy error likely)</li>`);
                    report.push(`<li>&nbsp;&nbsp;↳ <span class="error">[ANALYSIS]: FAILURE.</span> The JS bundle could not be loaded. This is a fatal error.</li>`);
                });
              promises.push(p2);
              report.push('</ul>');
          } else {
              report.push('<ul><li><span class="error">No <code>bundle.js</code> <code>&lt;script&gt;</code> tag found.</span></li></ul>');
          }

          // Final update
          Promise.allSettled(promises).then(() => {
              report.push('<hr style="margin: 10px 0; border: none; border-top: 1px dashed #ccc;">');
              report.push('<h4>Conclusion:</h4>');

              let conclusion = '';
              const hasBaseUriError = document.baseURI.startsWith('http');
              const hasImportMapError = !!importMap;

              if (hasBaseUriError || hasImportMapError) {
                  conclusion += "<p>The diagnostic tool has detected <span class='error'>CRITICAL ERRORS</span> that are preventing the application from loading. The <code>index.html</code> file being used by the preview environment is incorrect.</p>";
                  conclusion += "<ul>";
                  if(hasBaseUriError) conclusion += "<li>The <code>&lt;base&gt;</code> tag is forcing incorrect file paths.</li>";
                  if(hasImportMapError) conclusion += "<li>The <code>&lt;script type=\"importmap\"&gt;</code> tag is causing a fatal JavaScript conflict.</li>";
                  conclusion += "</ul>";
                  conclusion += "<p>This indicates that the preview environment is either caching an old version of <code>index.html</code> or is modifying it before serving it to the browser.</p>";
              } else {
                  conclusion += "<p class='ok'>No critical configuration errors (base URI, import map) were found in the loaded HTML. If assets are still failing to load, check the network paths and server configuration.</p>";
              }
              report.push(conclusion);

              container.innerHTML = report.join('');
          });

          // Initial render before async fetch
          container.innerHTML = report.join('');
        });
      })();
    </script>
    
    <link rel="stylesheet" href="/dist/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script 
      type="module" 
      src="/dist/bundle.js"
    ></script>
  </body>
</html>